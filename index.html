
<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <title>Crazy Cactus ‚Äî Binder Love (Online v2)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link reld.css
</head>
<body>
  <header class="cc-header">
    <div class="cc-brand">
      <h1>üåµ CRAZY CACTUS</h1>
      <div class="sub">Binder Love</div>
    </div>
    <nav class="cc-nav">
      <a class="nav-link active">Dashboard</a>
      <a class="nav-link">Profit Calc</a>
      <a class="nav-link">Binders</a>
    </nav>
    <div class="cc-user">
      <span class="muted">{{ user.displayName }}</span>
      <button class="btn ghost">Log Out</button>
    </div>
  </header>

  <div class="cc-wrap">
    <!-- SIDEBAR -->
    <aside class="cc-sidebar">
      <section class="card">
        <h3>üìä Portfolio</h3>
        <div class="metrics">
          <div class="pill">Value <b id="m-totalValue">0,00 kr.</b></div>
          <div class="pill">Cards <b id="m-totalCards">0</b></div>
          <div class="pill">Binders <b id="m-binders">1</b></div>
        </div>
      </section>

      <section class="card">
        <h3>üìö CARD VAULTS</h3>
        <div class="row">
          <input id="newBinderName" placeholder="+ Ny binder navn‚Ä¶" />
          <button class="btn" id="btnAddBinder">+ NEW BINDER</button>
        </div>
        <div class="hr"></div>
        <div id="binderList"></div>
      </section>

      <!-- API SETTINGS -->
      <section class="card">
        <h3>üõ†Ô∏è API Settings</h3>
        <div class="small muted">Pok√©mon TCG API v2 (alle calls kr√¶ver HTTPS + X-Api-Key).</div>
        <div class="row" style="margin-top:8px">
          <input id="apiBase" placeholder="Base URL (fx https://api.pokemontcg.io/v2)" />
        </div>
        <div class="row">
          <input id="apiToken" placeholder="API Key (X-Api-Key)" />
        </div>
        <div class="row">
          <button class="btn" id="btnTestApi">Test API</button>
          <span class="tag" id="apiStatus">Idle</span>
        </div>
        <div class="small muted" style="margin-top:8px">
          Tip: Af sikkerhedshensyn b√∏r en produktionsl√∏sning proxye n√∏glen via backend. (Doksen anbefaler ikke at dele n√∏glen offentligt). [1](https://docs.pokemontcg.io/getting-started/authentication/)
        </div>
      </section>
    </aside>

    <!-- MAIN -->
    <main class="cc-main">
      <section class="empty" id="emptyTop">
        <h4>This Desert is Empty</h4>
        <div>Plant your first seed and watch it grow!</div>
      </section>

      <section class="card">
        <h3>Find My Card</h3>
        <ol class="steps">
          <li>
            <label class="small muted">1. Era (Series)</label>
            <select id="selEra"></select>
          </li>
          <li>
            <label class="small muted">2. Set</label>
            <select id="selSet"></select>
          </li>
          <li class="flex">
            <div class="grow">
              <label class="small muted">3. Card</label>
              <select id="selCard"></select>
              <div class="small tag" id="loadState">LOADING...</div>
            </div>
            <div>
              <label class="small muted">Market Price</label>
              <div id="marketBox" class="pill">CHECKING...</div>
            </div>
          </li>
        </ol>
        <div class="row">
          <button class="btn primary" id="btnAddToBinder">ADD TO BINDER</button>
          <span class="tag" id="addedToast" style="display:none">ADDED TO COLLECTION!</span>
          <span class="spacer"></span>
          <span class="small muted">Active binder: <b id="activeBinderName">Master Archive</b></span>
        </div>
      </section>

      <section class="card">
        <div class="row">
          <h3 class="grow">{{ currentBinder ? currentBinder.name : 'Master List' }}</h3>
          <div class="row">
            <label class="small muted">Page size</label>
            <select id="selPageSize">
              <option>10</option><option selected>20</option><option>50</option><option>100</option>
            </select>
            <button class="btn ghost small" id="btnReset">Reset</button>
          </div>
        </div>

        <div class="row">
          <h4 class="grow">Profitability Analysis Engine</h4>
          <button id="btnDelete" class="btn danger" disabled>DELETE 0 ITEMS</button>
        </div>

        <table id="tbl">
          <thead>
            <tr>
              <th></th>
              <th>Visual</th>
              <th>Card Identity</th>
              <th>Binder Location</th>
              <th class="right">Raw Cost</th>
              <th class="right">Fees</th>
              <th>Target Grade</th>
              <th class="right">Est. Value</th>
              <th class="right">Net Profit</th>
              <th>Ops</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>

        <div class="row">
          <div class="small muted" id="visibleCount">0 items visible</div>
          <span class="spacer"></span>
          <button class="btn" id="btnPrev">PREV</button>
          <button class="btn" id="btnNext">NEXT</button>
        </div>
      </section>

      <section class="card">
        <h4>Master Archive</h4>
        <div class="small muted">Total: <span id="totalInMaster">0</span> Cards</div>
      </section>
    </main>
  </div>

  <script>
  // ===== UTIL =====
  const DKK = new Intl.NumberFormat('da-DK', { style: 'currency', currency: 'DKK', minimumFractionDigits: 2 });
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const uid = () => Math.random().toString(36).slice(2,10);
  const clamp = (n,a,b) => Math.max(a, Math.min(b, n));
  const toNum = v => { const n = parseFloat(v); return isNaN(n) ? 0 : n; };
  const debounce = (fn, d=250) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), d); }; };

  // ===== STORAGE =====
  const STORE_KEY = 'cactus_online_pokemontcg_v2';
  const defaultState = () => ({
    binders: [{ id:'master', name:'Master Archive' }],
    ui: { page:1, pageSize:20, filterBinder:'master', selEra:'', selSet:'', selCard:'' },
    collection: [],
    api: { base: 'https://api.pokemontcg.io/v2', token: '' }
  });
  let state = loadState();
  function loadState(){ try{ const raw = localStorage.getItem(STORE_KEY); return raw? JSON.parse(raw): defaultState(); }catch{ return defaultState(); } }
  function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

  // ===== API WRAPPER (Pok√©mon TCG v2) =====
  async function apiFetch(path, { timeoutMs=15000, page, pageSize, queryParams }={}){
    const controller = new AbortController(); const id = setTimeout(()=>controller.abort(), timeoutMs);
    const headers = { 'Accept':'application/json' };
    if (state.api.token) headers['X-Api-Key'] = state.api.token; // v2 key header
    const url = new URL(path, state.api.base);
    if (page) url.searchParams.set('page', page);
    if (pageSize) url.searchParams.set('pageSize', pageSize);
    if (queryParams) Object.entries(queryParams).forEach(([k,v]) => url.searchParams.set(k,v));
    const res = await fetch(url.toString(), { headers, signal: controller.signal, cache: 'no-store' });
    clearTimeout(id);
    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
    return res.json(); // { data, page, pageSize, count, totalCount }
  }

  // Cache for sets/cards
  const cache = { setsAll: null, cardsBySet: new Map() };

  async function fetchAllSets(){
    if (cache.setsAll) return cache.setsAll;
    const pageSize = 250; let page = 1; let all = [];
    // loop pages
    while(true){
      const json = await apiFetch('/sets', { page, pageSize });
      all = all.concat(json.data || []);
      if (all.length >= (json.totalCount || all.length)) break;
      page++;
    }
    cache.setsAll = all;
    return all;
  }
  function getSeriesList(sets){
    // unique list of series (Era)
    const series = Array.from(new Set((sets||[]).map(s => s.series).filter(Boolean))).sort();
    return series;
  }
  function getSetsBySeries(sets, series){
    return (sets||[]).filter(s => s.series === series);
  }

  async function fetchCardsForSet(setId){
    if (cache.cardsBySet.has(setId)) return cache.cardsBySet.get(setId);
    const pageSize = 250; let page = 1; let all = [];
    while(true){
      const json = await apiFetch('/cards', { page, pageSize, queryParams: { q: `set.id:${setId}` } });
      all = all.concat(json.data || []);
      if (all.length >= (json.totalCount || all.length)) break;
      page++;
    }
    cache.cardsBySet.set(setId, all);
    return all;
  }

  // Price extractor (TCGplayer/Cardmarket)
  function pickMarketPrice(card){
    try {
      const p = card?.tcgplayer?.prices || {};
      // Priorit√©r markedspris; fald tilbage til mid/avg
      const order = ['holofoil','reverseHolofoil','1stEditionHolofoil','1stEdition','unlimitedHolofoil','unlimited','normal'];
      for (const key of order){
        const obj = p[key];
        if (obj){
          const val = obj.market ?? obj.mid ?? obj.averagePrice ?? obj.low ?? obj.high;
          if (typeof val === 'number' && !isNaN(val)) return +val;
        }
      }
      const cm = card?.cardmarket?.prices || {};
      const cmVal = cm.averageSellPrice ?? cm.trendPrice ?? cm.avg30 ?? cm.avg7 ?? cm.lowPrice ?? cm.highPrice;
      if (typeof cmVal === 'number' && !isNaN(cmVal)) return +cmVal;
      return 0;
    } catch { return 0; }
  }

  // ===== BUSINESS =====
  const gradeMultipliers = { 'PSA 8': 0.85, 'PSA 9': 0.95, 'PSA 10': 1.15 };
  const estValue = it => +((it.market * (gradeMultipliers[it.grade] ?? 1)).toFixed(2));
  const profit   = it => +((estValue(it) - (toNum(it.rawCost)+toNum(it.fees))).toFixed(2));

  // ===== UI refs =====
  const el = {
    mTotalValue: $('#m-totalValue'), mTotalCards: $('#m-totalCards'), mBinders: $('#m-binders'),
    binderList: $('#binderList'), activeBinderName: $('#activeBinderName'),
    selEra: $('#selEra'), selSet: $('#selSet'), selCard: $('#selCard'),
    loadState: $('#loadState'), marketBox: $('#marketBox'), addedToast: $('#addedToast'),
    tbl: $('#tbl'), tbody: $('#tbody'), visibleCount: $('#visibleCount'),
    btnPrev: $('#btnPrev'), btnNext: $('#btnNext'), btnDelete: $('#btnDelete'),
    selPageSize: $('#selPageSize'), totalInMaster: $('#totalInMaster'), emptyTop: $('#emptyTop'),
    btnAddBinder: $('#btnAddBinder'), newBinderName: $('#newBinderName'), btnReset: $('#btnReset'),
    apiBase: $('#apiBase'), apiToken: $('#apiToken'), btnTestApi: $('#btnTestApi'), apiStatus: $('#apiStatus'),
  };

  // ===== RENDER =====
  function renderMetrics(){
    const items = filteredCollection();
    const totalValue = items.reduce((s,i)=> s+estValue(i), 0);
    el.mTotalValue.textContent = DKK.format(totalValue);
    el.mTotalCards.textContent = String(items.length);
    el.mBinders.textContent = String(state.binders.length);
    el.totalInMaster.textContent = String(state.collection.length);
    el.emptyTop.style.display = state.collection.length ? 'none' : 'block';
  }
  function renderBinders(){
    const frag = document.createDocumentFragment();
    state.binders.forEach(b => {
      const btn = document.createElement('button');
      btn.className = 'btn' + (state.ui.filterBinder===b.id ? ' primary' : '');
      btn.style.width='100%'; btn.style.marginBottom='8px';
      btn.textContent = b.name + (b.id==='master' ? ` ‚Äî Total: ${state.collection.length} Cards` : ` ‚Äî ${binderCount(b.id)} Cards`);
      btn.onclick = () => { state.ui.filterBinder=b.id; state.ui.page=1; el.activeBinderName.textContent=b.name; renderAll(); };
      frag.appendChild(btn);
    });
    el.binderList.innerHTML=''; el.binderList.appendChild(frag);
  }
  function binderCount(id){ return state.collection.filter(i=>i.binderId===id).length; }
  function filteredCollection(){ return state.ui.filterBinder==='master' ? state.collection : state.collection.filter(i=>i.binderId===state.ui.filterBinder); }

  async function renderFindSelectors(){
    el.loadState.textContent = 'LOADING...';
    try {
      const sets = await fetchAllSets();
      const series = getSeriesList(sets);
      // Era = Series
      el.selEra.innerHTML = [''].concat(series).map(e => e ? `<option value="${e}">${e}</option>` : `<option value="">SELECT ERA</option>`).join('');
      if (!state.ui.selEra) state.ui.selEra = series[0] ?? '';
      el.selEra.value = state.ui.selEra;

      const setsInSeries = getSetsBySeries(sets, state.ui.selEra);
      el.selSet.innerHTML = [''].concat(setsInSeries).map(s => s ? `<option value="${s.id}">${s.name}</option>` : `<option value="">SELECT SET</option>`).join('');
      if (!setsInSeries.find(s=>s?.id===state.ui.selSet)) state.ui.selSet = setsInSeries[0]?.id ?? '';
      el.selSet.value = state.ui.selSet;

      const cards = state.ui.selSet ? await fetchCardsForSet(state.ui.selSet) : [];
      el.selCard.innerHTML = [''].concat(cards).map(c => {
        if (!c) return `<option value="">${cards.length?'SELECT CARD':'EMPTY SET'}</option>`;
        return `<option value="${c.id}">#${c.number} ‚Äî ${c.name}</option>`;
      }).join('');
      if (!cards.find(c=>c?.id===state.ui.selCard)) state.ui.selCard = cards[0]?.id ?? '';
      el.selCard.value = state.ui.selCard;

      el.loadState.textContent = cards.length ? 'READY' : (setsInSeries.length ? 'SELECT CARD' : 'SELECT SET');
      renderMarketBox();
    } catch (err) {
      console.error('Finder load error', err);
      el.loadState.textContent = 'RETRY CONNECTION';
    }
  }

  const updatePriceDebounced = debounce(async () => {
    const cId = state.ui.selCard;
    if (!cId){ el.marketBox.textContent='CHECKING...'; return; }
    try {
      const list = await fetchCardsForSet(state.ui.selSet);
      const card = list.find(c => c.id === cId);
      const price = pickMarketPrice(card);
      el.marketBox.textContent = DKK.format(+price || 0);
    } catch (err) {
      console.error('Price error', err);
      el.marketBox.textContent = 'ERROR';
    }
  }, 250);

  function renderMarketBox(){ updatePriceDebounced(); }

  function renderTable(){
    const all = filteredCollection();
    const pageSize = +state.ui.pageSize || 20;
    const maxPage = Math.max(1, Math.ceil(all.length / pageSize));
    state.ui.page = clamp(state.ui.page, 1, maxPage);
    const start = (state.ui.page-1)*pageSize;
    const pageItems = all.slice(start, start+pageSize);

    el.tbody.innerHTML='';
    if (!pageItems.length){
      const tr = document.createElement('tr'); const td = document.createElement('td'); td.colSpan=10;
      td.innerHTML = `<div class="empty">No cards buried here...</div>`;
      tr.appendChild(td); el.tbody.appendChild(tr);
    } else {
      const frag = document.createDocumentFragment();
      pageItems.forEach(it => {
        const tr = document.createElement('tr');
        const imageCell = `<img src="${it.imageSmall || ''}" alt="${it.name}" style="width:48px;height:auto;border-radiusbox" class="rowChk" data-row="${it.rowId}"></td>
          <td class="center">${imageCell || `<div class="tag">#${it.number}</div>`}</td>
          <td>
            <div><b>${it.name}</b></div>
            <div class="small muted">${it.setId} ¬∑ #${it.number}</div>
          </td>
          <td>${state.binders.find(b=>b.id===it.binderId)?.name || 'Master Archive'}</td>
          <td class="right"><input type="number" step="0.01" value="${toNum(it.rawCost)}" data-row="${it.rowId}" data-k="rawCost"></td>
          <td class="right"><input type="number" step="0.01" value="${toNum(it.fees)}" data-row="${it.rowId}" data-k="fees"></td>
          <td>
            <select data-row="${it.rowId}" data-k="grade">
              ${Object.keys(gradeMultipliers).map(g => `<option ${it.grade===g?'selected':''}>${g}</option>`).join('')}
            </select>
          </td>
          <td class="right">${DKK.format(estValue(it))}</td>
          <td class="right ${profit(it)>=0?'pos':''}">${DKK.format(profit(it))}</td>
          <td><button class="btn warn small" data-del="${it.rowId}">Remove</button></td>
        `;
        frag.appendChild(tr);
      });
      el.tbody.appendChild(frag);
    }

    // events
    $$('#tbody input[type="number"]').forEach(inp => {
      inp.addEventListener('change', e => {
        const rowId = e.target.dataset.row, key=e.target.dataset.k;
        const it = state.collection.find(x=>x.rowId===rowId);
        if (it){ it[key]=toNum(e.target.value); renderMetrics(); renderTable(); saveState(); }
      });
    });
    $$('#tbody select[data-k="grade"]').forEach(sel => {
      sel.addEventListener('change', e => {
        const rowId = e.target.dataset.row;
        const it = state.collection.find(x=>x.rowId===rowId);
        if (it){ it.grade=e.target.value; renderMetrics(); renderTable(); saveState(); }
      });
    });
    $$('#tbody button[data-del]').forEach(btn => {
      btn.addEventListener('click', e => {
        const rowId = e.target.dataset.del;
        state.collection = state.collection.filter(x=>x.rowId!==rowId);
        renderAll();
      });
    });

    const updateDelete = () => {
      const selected = $$('#tbody .rowChk:checked').map(c=>c.dataset.row);
      el.btnDelete.disabled = selected.length===0;
      el.btnDelete.textContent = `DELETE ${selected.length} ITEMS`;
      return selected;
    };
    $$('#tbody .rowChk').forEach(c => c.addEventListener('change', updateDelete));
    el.btnDelete.onclick = () => {
      const rows = updateDelete();
      if (!rows.length) return;
      state.collection = state.collection.filter(x => !rows.includes(x.rowId));
      renderAll();
    };

    el.visibleCount.textContent = `${pageItems.length} items visible`;
    el.btnPrev.onclick = () => { if (state.ui.page>1){ state.ui.page--; renderTable(); } };
    el.btnNext.onclick = () => { if (state.ui.page<maxPage){ state.ui.page++; renderTable(); } };
  }

  // ===== Finder events =====
  $('#selEra').addEventListener('change', async () => {
    state.ui.selEra = $('#selEra').value; state.ui.selSet=''; state.ui.selCard='';
    await renderFindSelectors(); saveState();
  });
  $('#selSet').addEventListener('change', async () => {
    state.ui.selSet = $('#selSet').value; state.ui.selCard='';
    await renderFindSelectors(); saveState();
  });
  $('#selCard').addEventListener('change', () => {
    state.ui.selCard = $('#selCard').value; renderMarketBox(); saveState();
  });

  $('#btnAddToBinder').addEventListener('click', async () => {
    const setId = state.ui.selSet, cId = state.ui.selCard;
    if (!setId || !cId) return;
    const list = await fetchCardsForSet(setId);
    const card = list.find(c=>c.id===cId);
    const row = {
      rowId: uid(), cardId: card.id, setId,
      number: card.number, name: card.name,
      market: pickMarketPrice(card),
      imageSmall: card.images?.small || '',
      binderId: state.ui.filterBinder || 'master', rawCost: 0, fees: 0, grade: 'PSA 9'
    };
    state.collection.unshift(row);
    toastAdded();
    renderAll();
  });

  // ===== Misc events =====
  el.selPageSize.addEventListener('change', () => {
    state.ui.pageSize = +el.selPageSize.value; state.ui.page=1;
    renderTable(); saveState();
  });
  el.btnAddBinder.addEventListener('click', () => {
    const name = (el.newBinderName.value || '').trim(); if (!name) return;
    const id = uid(); state.binders.push({ id, name }); state.ui.filterBinder=id;
    el.newBinderName.value=''; renderAll();
  });
  el.btnReset.addEventListener('click', () => {
    if (!confirm('Er du sikker? Dette sletter lokale data.')) return;
    state = defaultState(); applyApiToInputs(); cache.setsAll=null; cache.cardsBySet.clear(); renderAll(); renderFindSelectors();
  });
  function toastAdded(){ el.addedToast.style.display='inline-block'; setTimeout(()=>el.addedToast.style.display='none', 1500); }

  // ===== API Settings UI =====
  function applyApiToInputs(){
    el.apiBase.value = state.api.base || '';
    el.apiToken.value = state.api.token || '';
  }
  function readApiFromInputs(){
    state.api.base = (el.apiBase.value || '').trim();
    state.api.token = (el.apiToken.value || '').trim();
    saveState();
  }
  ['input','change'].forEach(evt => [el.apiBase, el.apiToken].forEach(inp => inp.addEventListener(evt, readApiFromInputs)));
  el.btnTestApi.addEventListener('click', async () => {
    el.apiStatus.textContent='Testing...';
    try {
      readApiFromInputs();
      const sets = await fetchAllSets();
      const series = getSeriesList(sets);
      el.apiStatus.textContent = `OK (${series.length} series)`;
      await renderFindSelectors();
    } catch (err) {
      console.error('API test failed', err);
      el.apiStatus.textContent='FAILED';
    }
  });

  // ===== INIT =====
  (async function init(){
    applyApiToInputs();
    // (Optional) for nem test: forudfyld n√∏gle
    if (!state.api.token) { state.api.token = ''; } // inds√¶t manuelt i UI
    try { await renderFindSelectors(); } catch(e){ console.warn('Initial load failed:', e); el.loadState.textContent='SET API BASE + KEY'; }
    renderAll();
  })();

  function renderAll(){ renderMetrics(); renderBinders(); renderTable(); saveState(); }
  </script>
</body>
</html>
