<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crazy Cactus | Binder Love</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Kronborg1980/CrazyCactus/main/channels4_profile.jpg">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --cactus-green: #2ecc71;
            --cactus-dark: #27ae60;
            --dark-bg: #0f1012;
            --card-bg: #18191c;
            --border-color: #2d3035;
        }

        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--dark-bg);
            color: #e2e8f0;
            /* Subtle texture pattern */
            background-image: radial-gradient(#2d3035 1px, transparent 1px);
            background-size: 20px 20px;
            padding-bottom: 80px; /* Space for mobile nav */
        }

        [v-cloak] { display: none; }

        /* --- UI COMPONENTS --- */
        .cactus-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }
        
        .cactus-btn-primary {
            background-color: var(--cactus-green);
            color: #000;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 10px 20px;
            border-radius: 8px;
            transition: transform 0.1s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 0 var(--cactus-dark);
        }
        .cactus-btn-primary:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 var(--cactus-dark);
        }
        .cactus-btn-primary:disabled {
            background-color: #333;
            color: #666;
            box-shadow: none;
            transform: none;
        }

        .cactus-input {
            background: #000;
            border: 2px solid #333;
            border-radius: 8px;
            color: white;
            padding: 10px;
            width: 100%;
            font-weight: 600;
        }
        .cactus-input:focus {
            border-color: var(--cactus-green);
            outline: none;
        }

        /* --- NAVIGATION --- */
        .nav-item {
            color: #94a3b8;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 8px;
            transition: 0.2s;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.05); }
        .nav-item.active {
            background: rgba(46, 204, 113, 0.15);
            color: var(--cactus-green);
        }

        /* --- TABLE STYLES --- */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th {
            text-align: left;
            padding: 12px;
            font-size: 11px;
            text-transform: uppercase;
            color: #64748b;
            border-bottom: 2px solid #2d3035;
        }
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #2d3035;
            font-size: 13px;
        }
        .data-table tr:hover td { background-color: rgba(255,255,255,0.02); }

        /* Animation Utils */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>

<div id="app" v-cloak class="min-h-screen flex flex-col">

    <nav class="sticky top-0 z-40 bg-[#0f1012]/95 backdrop-blur border-b border-[#2d3035] shadow-lg">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full border-2 border-green-500 overflow-hidden bg-black p-0.5">
                    <img src="https://raw.githubusercontent.com/Kronborg1980/CrazyCactus/main/channels4_profile.jpg" class="w-full h-full object-cover rounded-full">
                </div>
                <div>
                    <h1 class="font-black text-xl leading-none text-white tracking-wide">CRAZY CACTUS</h1>
                    <div class="text-[10px] font-bold text-green-500 uppercase">Binder Love</div>
                </div>
            </div>

            <div class="hidden md:flex items-center gap-2">
                <div @click="switchView('collection')" class="nav-item" :class="{active: currentView==='collection'}">
                    <i class="fa-solid fa-grid-2"></i> Dashboard
                </div>
                <div @click="switchView('calculator')" class="nav-item" :class="{active: currentView==='calculator'}">
                    <i class="fa-solid fa-calculator"></i> Profit Calc
                </div>
                <div @click="switchView('binders')" class="nav-item" :class="{active: currentView==='binders'}">
                    <i class="fa-solid fa-book-open"></i> Binders
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div v-if="user" class="hidden md:flex flex-col items-end">
                    <span class="text-xs font-bold text-white">{{ user.displayName }}</span>
                    <button @click="logout" class="text-[10px] text-red-400 hover:text-red-300 font-bold uppercase">Log Out</button>
                </div>
                <button v-else @click="loginWithGoogle" class="hidden md:block text-xs font-bold text-green-500 border border-green-500 px-3 py-1.5 rounded hover:bg-green-500 hover:text-black transition">
                    TRAINER LOGIN
                </button>
                
                <button @click="openSearch" class="cactus-btn-primary text-sm">
                    <i class="fa-solid fa-plus"></i> <span class="hidden sm:inline">Add Card</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="flex-grow w-full max-w-7xl mx-auto px-4 py-8">
        
        <div v-if="currentView !== 'calculator'" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="cactus-card p-6 flex justify-between items-center bg-gradient-to-br from-[#18191c] to-[#1e2024]">
                <div>
                    <div class="text-xs font-bold text-gray-500 uppercase mb-1">Portfolio Value</div>
                    <div class="text-3xl font-black text-white tracking-tight">${{ formatNumber(totalValue) }}</div>
                </div>
                <div class="w-12 h-12 rounded-full bg-green-500/10 flex items-center justify-center text-green-500 text-xl">
                    <i class="fa-solid fa-sack-dollar"></i>
                </div>
            </div>
            <div class="cactus-card p-6 flex justify-between items-center">
                <div>
                    <div class="text-xs font-bold text-gray-500 uppercase mb-1">Total Cards</div>
                    <div class="text-3xl font-black text-white tracking-tight">{{ cards.length }}</div>
                </div>
                <div class="w-12 h-12 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-500 text-xl">
                    <i class="fa-solid fa-layer-group"></i>
                </div>
            </div>
            <div class="cactus-card p-6 flex justify-between items-center">
                <div>
                    <div class="text-xs font-bold text-gray-500 uppercase mb-1">Binders</div>
                    <div class="text-3xl font-black text-white tracking-tight">{{ binders.length }}</div>
                </div>
                <div class="w-12 h-12 rounded-full bg-purple-500/10 flex items-center justify-center text-purple-500 text-xl">
                    <i class="fa-solid fa-folder-open"></i>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'collection'">
            <div v-if="cards.length === 0" class="text-center py-20 cactus-card border-dashed">
                <i class="fa-solid fa-cactus text-6xl text-gray-700 mb-4"></i>
                <h3 class="text-xl font-bold text-gray-400">Your collection is empty</h3>
                <p class="text-gray-600 mb-6">Start by adding your first Pokemon card.</p>
                <button @click="openSearch" class="cactus-btn-primary">Find My Card</button>
            </div>

            <div v-else class="space-y-8">
                <div v-for="(setGroup, setName) in cardsBySet" :key="setName" class="cactus-card overflow-hidden">
                    <div class="px-6 py-4 border-b border-[#2d3035] bg-[#1a1c20] flex justify-between items-center">
                        <h3 class="font-black text-lg text-white uppercase">{{ setName }}</h3>
                        <span class="text-xs font-bold bg-green-500/20 text-green-500 px-2 py-1 rounded">
                            {{ setGroup.uniqueCount }} / {{ getSetTotal(setName) }}
                        </span>
                    </div>
                    <div class="p-6 grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-6">
                        <div v-for="card in setGroup.cards" :key="card.uid" @click="openCardDetail(card)" 
                             class="group cursor-pointer relative transition hover:-translate-y-1">
                            <div class="relative rounded-lg overflow-hidden border-2 border-transparent group-hover:border-green-500 shadow-md">
                                <img :src="card.image" class="w-full object-cover">
                                <div class="absolute bottom-0 left-0 right-0 bg-black/80 p-1 text-center">
                                    <span class="text-[10px] font-bold text-green-400">${{ Math.round(card.market) }}</span>
                                </div>
                            </div>
                            <div class="mt-2 text-center">
                                <div class="text-xs font-bold text-white truncate">{{ card.name }}</div>
                                <div class="text-[10px] font-bold text-gray-500">x{{ setGroup.cardCounts[card.id] }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'binders'">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-white">MY BINDERS</h2>
                <button @click="createBinder" class="text-xs font-bold text-gray-400 hover:text-white border border-gray-600 px-3 py-1.5 rounded">+ NEW BINDER</button>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <div @click="selectBinder(null); switchView('calculator')" class="cactus-card p-6 cursor-pointer hover:border-green-500 transition group relative overflow-hidden h-40 flex flex-col justify-end">
                    <i class="fa-solid fa-database text-6xl text-[#2d3035] absolute top-4 right-4 group-hover:text-green-500/20 transition"></i>
                    <h3 class="text-xl font-black text-white relative z-10">MASTER COLLECTION</h3>
                    <p class="text-xs font-bold text-gray-500 relative z-10">View all {{ cards.length }} cards</p>
                </div>

                <div v-for="b in binders" :key="b.id" @click="selectBinder(b); switchView('calculator')" class="cactus-card p-6 cursor-pointer hover:border-green-500 transition group relative overflow-hidden h-40 flex flex-col justify-end">
                    <div class="absolute top-4 right-4 flex gap-2 z-20">
                        <button @click.stop="renameBinder(b)" class="text-gray-600 hover:text-white"><i class="fa-solid fa-pen"></i></button>
                        <button @click.stop="deleteBinder(b.id)" class="text-gray-600 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <i class="fa-solid fa-book text-6xl text-[#2d3035] absolute top-4 right-8 group-hover:text-green-500/20 transition"></i>
                    <h3 class="text-xl font-black text-white relative z-10 truncate pr-8">{{ b.name }}</h3>
                    <p class="text-xs font-bold text-green-500 relative z-10">{{ getBinderCount(b.id) }} Cards</p>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'calculator'">
            <div class="mb-4 flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h2 class="text-2xl font-black text-white uppercase">{{ currentBinder ? currentBinder.name : 'Master List' }}</h2>
                    <p class="text-xs font-bold text-gray-500">Manage costs, fees, and potential profit.</p>
                </div>
                <div class="flex items-center gap-2">
                    <button v-if="selectedIds.length > 0" @click="deleteSelected" class="bg-red-500/10 text-red-500 text-xs font-bold px-4 py-2 rounded hover:bg-red-500 hover:text-white transition">
                        DELETE SELECTED ({{ selectedIds.length }})
                    </button>
                </div>
            </div>

            <div class="cactus-card overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="data-table min-w-[800px]">
                        <thead>
                            <tr class="bg-[#1a1c20]">
                                <th class="w-10 text-center"><input type="checkbox" :checked="isAllSelected" @click="toggleSelectAll"></th>
                                <th class="w-16 text-center">Image</th>
                                <th @click="setSort('name')" class="cursor-pointer hover:text-white">Card Details <i class="fa-solid fa-sort ml-1"></i></th>
                                <th>Location</th>
                                <th class="text-right cursor-pointer hover:text-white" @click="setSort('rawCost')">Cost ($) <i class="fa-solid fa-sort ml-1"></i></th>
                                <th class="text-right">Fee ($)</th>
                                <th class="text-center">Target</th>
                                <th class="text-right cursor-pointer hover:text-white" @click="setSort('market')">Est. Value <i class="fa-solid fa-sort ml-1"></i></th>
                                <th class="text-right cursor-pointer hover:text-white" @click="setSort('profit')">Profit <i class="fa-solid fa-sort ml-1"></i></th>
                                <th class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-if="paginatedCards.length === 0">
                                <td colspan="10" class="text-center py-10 text-gray-500 font-bold">No cards found in this view.</td>
                            </tr>
                            <tr v-for="c in paginatedCards" :key="c.uid" :class="{'bg-green-500/5': selectedIds.includes(c.uid)}">
                                <td class="text-center"><input type="checkbox" :value="c.uid" v-model="selectedIds"></td>
                                <td class="text-center">
                                    <img :src="c.image" class="w-8 h-10 object-cover rounded border border-gray-700 mx-auto cursor-pointer" @click="openCardDetail(c)">
                                </td>
                                <td>
                                    <div class="font-bold text-white cursor-pointer hover:text-green-500" @click="openCardDetail(c)">{{ c.name }}</div>
                                    <div class="text-[10px] text-gray-500">{{ c.set }} #{{ c.number }}</div>
                                </td>
                                <td>
                                    <select v-model="c.binderId" @change="updateCardBinder(c)" class="bg-[#0f1012] border border-gray-700 rounded text-xs px-2 py-1 text-gray-300 w-full">
                                        <option :value="null">Master</option>
                                        <option v-for="b in binders" :value="b.id">{{ b.name }}</option>
                                    </select>
                                </td>
                                <td><input v-model.number="c.rawCost" @change="saveData()" type="number" class="bg-transparent text-right w-full border-b border-gray-700 focus:border-green-500 outline-none pb-1"></td>
                                <td><input v-model.number="c.fee" @change="saveData()" type="number" class="bg-transparent text-right w-full border-b border-gray-700 focus:border-green-500 outline-none pb-1"></td>
                                <td class="text-center">
                                    <select v-model="c.targetGrade" @change="saveData()" class="bg-[#0f1012] border border-gray-700 rounded text-xs px-1 py-1 text-green-500 font-bold">
                                        <option value="10">PSA 10</option>
                                        <option value="9">PSA 9</option>
                                        <option value="8">PSA 8</option>
                                    </select>
                                </td>
                                <td class="text-right font-mono font-bold text-gray-400">${{ formatNumber(getEstValue(c)) }}</td>
                                <td class="text-right font-mono font-bold" :class="getProfit(c) >= 0 ? 'text-green-500' : 'text-red-500'">
                                    ${{ Math.round(getProfit(c)) }}
                                </td>
                                <td class="text-center">
                                    <button @click="deleteCard(c.uid)" class="text-gray-600 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="p-4 border-t border-[#2d3035] flex justify-between items-center bg-[#1a1c20]">
                    <span class="text-xs font-bold text-gray-500">{{ paginatedCards.length }} items showing</span>
                    <div class="flex gap-2">
                        <button @click="prevPage" :disabled="currentPage===1" class="px-3 py-1 bg-black border border-gray-700 rounded text-xs font-bold hover:border-green-500 disabled:opacity-50">PREV</button>
                        <button @click="nextPage" :disabled="currentPage===totalPages" class="px-3 py-1 bg-black border border-gray-700 rounded text-xs font-bold hover:border-green-500 disabled:opacity-50">NEXT</button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div class="md:hidden fixed bottom-0 left-0 w-full bg-[#18191c] border-t border-[#2d3035] flex justify-around items-center h-16 z-50 shadow-2xl">
        <button @click="switchView('collection')" class="flex flex-col items-center gap-1 w-1/3 text-gray-500" :class="{'text-green-500': currentView==='collection'}">
            <i class="fa-solid fa-grid-2 text-xl"></i>
            <span class="text-[10px] font-bold uppercase">Home</span>
        </button>
        <button @click="switchView('calculator')" class="flex flex-col items-center gap-1 w-1/3 text-gray-500" :class="{'text-green-500': currentView==='calculator'}">
            <i class="fa-solid fa-calculator text-xl"></i>
            <span class="text-[10px] font-bold uppercase">Profit</span>
        </button>
        <button @click="switchView('binders')" class="flex flex-col items-center gap-1 w-1/3 text-gray-500" :class="{'text-green-500': currentView==='binders'}">
            <i class="fa-solid fa-book-open text-xl"></i>
            <span class="text-[10px] font-bold uppercase">Binders</span>
        </button>
    </div>

    <Transition name="fade">
        <div v-if="showSearch" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
            <div class="bg-[#18191c] w-full max-w-4xl h-[85vh] rounded-xl border border-gray-700 shadow-2xl flex flex-col overflow-hidden">
                <div class="p-6 border-b border-gray-700 flex justify-between items-center bg-[#0f1012]">
                    <h2 class="text-xl font-black text-white uppercase">Find My Card</h2>
                    <button @click="showSearch=false" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark text-2xl"></i></button>
                </div>
                
                <div class="p-6 grid grid-cols-2 md:grid-cols-4 gap-4 bg-[#141518] border-b border-gray-700 shrink-0">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Era</label>
                        <select v-model="selectedEra" class="cactus-input text-xs"><option value="">Select Era</option><option v-for="e in eras" :value="e">{{ e }}</option></select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Set</label>
                        <select v-model="selectedSet" class="cactus-input text-xs" :disabled="!selectedEra"><option value="">Select Set</option><option v-for="s in filteredSets" :value="s.id">{{ s.name }}</option></select>
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Pokemon Name</label>
                        <input v-model="query" @input="debouncedSearch" class="cactus-input text-xs" placeholder="e.g. Charizard" :disabled="!selectedSet">
                    </div>
                    <div class="flex items-end">
                        <button @click="fetchCards(1)" :disabled="isSearching || !selectedSet" class="w-full bg-white text-black font-bold text-xs py-3 rounded uppercase hover:bg-green-500 transition disabled:opacity-50">
                            {{ isSearching ? 'Searching...' : 'Search' }}
                        </button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-6 bg-[#0f1012]">
                     <div v-if="paginatedSearchResults.length > 0" class="flex justify-end gap-2 mb-4 sticky top-0 z-10">
                         <button @click="prevPage" :disabled="searchPage === 1" class="bg-black border border-gray-700 text-[10px] px-3 py-1 text-white rounded">Prev</button>
                         <span class="bg-black border border-gray-700 text-[10px] px-3 py-1 text-green-500 rounded">{{ searchPage }}</span>
                         <button @click="nextPage" :disabled="searchPage === totalSearchPages" class="bg-black border border-gray-700 text-[10px] px-3 py-1 text-white rounded">Next</button>
                     </div>

                     <div v-if="!isSearching && searchResults.length === 0" class="flex flex-col items-center justify-center h-full opacity-30">
                         <i class="fa-solid fa-magnifying-glass text-5xl mb-4"></i>
                         <p class="font-bold uppercase">Waiting for input</p>
                     </div>

                     <div v-else class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">
                         <div v-for="card in paginatedSearchResults" :key="card.id" @click="addCard(card)" 
                              class="bg-[#18191c] p-2 rounded border border-transparent hover:border-green-500 cursor-pointer group relative">
                             <img :src="card.images.small" class="w-full rounded mb-2 shadow-sm">
                             <div class="text-[10px] font-bold text-white truncate">{{ card.name }}</div>
                             <div class="text-[10px] text-gray-500">Price: ${{ formatNumber(getCardPrice(card)) }}</div>
                             <div v-if="addedIds.includes(card.id)" class="absolute inset-0 bg-green-500/90 flex items-center justify-center rounded font-bold text-black uppercase animate-pulse">
                                 Added!
                             </div>
                         </div>
                     </div>
                </div>
            </div>
        </div>
    </Transition>

    <Transition name="fade">
        <div v-if="detailCard" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm">
            <div class="bg-[#18191c] w-full max-w-2xl rounded-xl border border-gray-700 shadow-2xl flex flex-col md:flex-row overflow-hidden relative">
                <button @click="detailCard=null" class="absolute top-4 right-4 z-20 text-gray-500 hover:text-white bg-black/50 rounded-full w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>

                <div class="w-full md:w-1/2 bg-[#0f1012] p-8 flex items-center justify-center border-b md:border-b-0 md:border-r border-gray-700">
                    <img :src="detailCard.image.replace('small','large')" class="max-h-[50vh] object-contain drop-shadow-xl rounded">
                </div>

                <div class="w-full md:w-1/2 p-8 flex flex-col">
                    <h2 class="text-2xl font-black text-white uppercase leading-tight mb-2">{{ detailCard.name }}</h2>
                    <div class="flex gap-2 text-xs font-bold text-gray-500 mb-6">
                        <span class="bg-gray-800 px-2 py-1 rounded border border-gray-700">{{ detailCard.set }}</span>
                        <span class="bg-gray-800 px-2 py-1 rounded border border-gray-700">#{{ detailCard.number }}</span>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div>
                            <div class="text-[10px] font-bold text-gray-500 uppercase">Paid Price</div>
                            <div class="text-xl font-bold text-white">${{ formatNumber(detailCard.rawCost) }}</div>
                        </div>
                        <div>
                            <div class="text-[10px] font-bold text-gray-500 uppercase">Potential Value</div>
                            <div class="text-xl font-bold text-green-500">${{ formatNumber(getEstValue(detailCard)) }}</div>
                        </div>
                    </div>

                    <div class="mt-auto border-t border-gray-700 pt-6">
                         <button @click="deleteCard(detailCard.uid)" class="w-full border border-red-500/50 text-red-500 font-bold text-xs uppercase py-3 rounded hover:bg-red-500 hover:text-white transition">
                             Remove Card from Collection
                         </button>
                    </div>
                </div>
            </div>
        </div>
    </Transition>

</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBnb9VlLk4sNbj89beWtb2hmLGsvhgb6TE",
        authDomain: "gladiator-portfolio.firebaseapp.com",
        projectId: "gladiator-portfolio",
        storageBucket: "gladiator-portfolio.firebasestorage.app",
        messagingSenderId: "61051937804",
        appId: "1:61051937804:web:535cbbcb5417c4bde67a29"
    };

    let auth, db, provider;
    try {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        provider = new firebase.auth.GoogleAuthProvider();
    } catch(e) { console.log("Guest Mode"); }

    const { createApp } = Vue;
    let searchController = null;

    createApp({
        data() {
            return {
                user: null, currentView: 'collection', currentBinder: null, 
                localBinders: [], localCards: [], cloudBinders: [], cloudCards: [],
                showSearch: false, detailCard: null, setsLoading: false, isSearching: false,
                allSets: [], eras: [], selectedEra: "", selectedSet: "", query: "", targetBinder: 'master', searchResults: [],
                cacheKey: 'cactus_reset_v2',
                
                totalSetData: {}, 
                
                sortBy: 'profit', sortDesc: true, currentPage: 1, itemsPerPage: 30, 
                searchPage: 1, searchPerPage: 18, 
                addedIds: [], selectedIds: [], 
                searchSort: 'price-desc', 
                totalSearchPagesCount: 1, 
                searchCache: {}, 
                searchTimeout: null
            }
        },
        watch: {
            selectedEra(n, o) { if(n!==o) { this.selectedSet=""; this.searchResults=[]; this.searchPage=1; this.query=""; this.searchCache={}; } },
            selectedSet(n, o) { if(n!==o) { this.searchResults=[]; this.searchPage=1; this.query=""; this.searchCache={}; } }
        },
        mounted() {
            this.loadLocalData();
            this.loadSetsAPI(); 
            if(auth) auth.onAuthStateChanged(u => { if(u) { this.user=u; this.initCloudData(); } else { this.user=null; } });
        },
        computed: {
            binders() { return this.user ? this.cloudBinders : this.localBinders; },
            cards() { return this.user ? this.cloudCards : this.localCards; },
            displayCards() { 
                let list = this.cards; 
                if (this.currentBinder) list = this.cards.filter(c => c.binderId === this.currentBinder.id);
                return list;
            },
            isAllSelected() { return this.displayCards.length > 0 && this.selectedIds.length === this.displayCards.length; },
            sortedCards() {
                let list = [...this.displayCards];
                return list.sort((a, b) => {
                    let valA, valB;
                    if(this.sortBy === 'name') { valA = a.name.toLowerCase(); valB = b.name.toLowerCase(); } 
                    else if(this.sortBy === 'rawCost') { valA = a.rawCost || 0; valB = b.rawCost || 0; } 
                    else if(this.sortBy === 'market') { valA = this.getEstValue(a); valB = this.getEstValue(b); } 
                    else if(this.sortBy === 'profit') { valA = this.getProfit(a); valB = this.getProfit(b); } 
                    else { valA = a.id; valB = b.id; }
                    if(valA < valB) return this.sortDesc ? 1 : -1;
                    if(valA > valB) return this.sortDesc ? -1 : 1;
                    return 0;
                });
            },
            totalPages() { return Math.ceil(this.sortedCards.length / this.itemsPerPage); },
            paginatedCards() {
                const start = (this.currentPage - 1) * this.itemsPerPage;
                return this.sortedCards.slice(start, start + this.itemsPerPage);
            },
            cardsBySet() {
                const grouped = {};
                this.cards.forEach(c => {
                    if(!grouped[c.set]) grouped[c.set] = { cards: [], uniqueCardIds: new Set(), cardCounts: {}, uniqueCount: 0 };
                    grouped[c.set].cards.push(c);
                    grouped[c.set].uniqueCardIds.add(c.id); 
                    grouped[c.set].cardCounts[c.id] = (grouped[c.set].cardCounts[c.id] || 0) + 1;
                });
                for (const setName in grouped) {
                    grouped[setName].uniqueCount = grouped[setName].uniqueCardIds.size;
                    grouped[setName].cards.sort((a,b) => a.number.localeCompare(b.number, undefined, {numeric: true}));
                    const uniqueCards = [];
                    const seenIds = new Set();
                    grouped[setName].cards.forEach(card => {
                        if (!seenIds.has(card.id)) { uniqueCards.push(card); seenIds.add(card.id); }
                    });
                    grouped[setName].cards = uniqueCards;
                }
                return grouped;
            },
            paginatedSearchResults() { return this.searchResults; },
            totalSearchPages() { return this.totalSearchPagesCount; },
            filteredSets() { return this.allSets.filter(s => s.series === this.selectedEra); },
            totalValue() { return this.displayCards.reduce((sum, c) => sum + (c.market || 0), 0); },
        },
        methods: {
            switchView(view) { this.currentView = view; this.currentBinder = null; window.scrollTo(0,0); },
            loginWithGoogle() { if(auth) auth.signInWithPopup(provider).catch(e => alert(e.message)); },
            logout() { if(auth) auth.signOut(); },
            
            getSetTotal(setName) { const set = this.totalSetData[setName]; return (set?.total || set?.printedTotal || '?'); },
            toggleSelectAll() { this.selectedIds = this.isAllSelected ? [] : this.displayCards.map(c => c.uid); },
            deleteSelected() {
                if(!confirm(`Delete ${this.selectedIds.length} cards?`)) return;
                this.selectedIds.forEach(uid => {
                    if(this.user) db.collection('users').doc(this.user.uid).collection('cards').doc(uid).delete();
                    else this.localCards = this.localCards.filter(c => c.uid !== uid);
                });
                this.selectedIds = [];
                this.saveData();
            },
            setSort(key) {
                if(this.sortBy === key) this.sortDesc = !this.sortDesc; 
                else { this.sortBy = key; this.sortDesc = true; }
                this.currentPage = 1; 
            },
            nextPage() { if(this.currentView === 'calculator' ? this.currentPage < this.totalPages : this.searchPage < this.totalSearchPagesCount) this.currentView === 'calculator' ? this.currentPage++ : this.fetchCards(this.searchPage + 1); },
            prevPage() { if(this.currentView === 'calculator' ? this.currentPage > 1 : this.searchPage > 1) this.currentView === 'calculator' ? this.currentPage-- : this.fetchCards(this.searchPage - 1); },
            
            loadLocalData() {
                const b = localStorage.getItem('cactus_binders'); if(b) this.localBinders = JSON.parse(b);
                const c = localStorage.getItem('cactus_cards'); if(c) this.localCards = JSON.parse(c);
            },
            saveData() { if(!this.user) { localStorage.setItem('cactus_binders', JSON.stringify(this.localBinders)); localStorage.setItem('cactus_cards', JSON.stringify(this.localCards)); } },
            initCloudData() {
                db.collection('users').doc(this.user.uid).collection('binders').onSnapshot(s => this.cloudBinders = s.docs.map(d => ({id: d.id, ...d.data()})));
                db.collection('users').doc(this.user.uid).collection('cards').onSnapshot(s => this.cloudCards = s.docs.map(d => ({uid: d.id, ...d.data()})));
            },
            createBinder() {
                const name = prompt("Name your new binder:");
                if(!name) return;
                if(this.user) db.collection('users').doc(this.user.uid).collection('binders').add({ name, createdAt: new Date() });
                else { this.localBinders.push({ id: Date.now().toString(), name }); this.saveData(); }
            },
            renameBinder(b) {
                const newName = prompt("Rename binder:", b.name);
                if (!newName || newName === b.name) return;
                if (this.user) db.collection('users').doc(this.user.uid).collection('binders').doc(b.id).update({ name: newName });
                else { const local = this.localBinders.find(x => x.id === b.id); if (local) { local.name = newName; this.saveData(); } }
            },
            deleteBinder(id) {
                if(!confirm("Delete this binder? Cards remain in master.")) return;
                if(this.user) db.collection('users').doc(this.user.uid).collection('binders').doc(id).delete();
                else { this.localBinders = this.localBinders.filter(b => b.id !== id); this.saveData(); }
            },
            addCard(c) {
                const market = this.getCardPrice(c);
                const cardData = {
                    id: c.id, name: c.name, set: this.allSets.find(s=>s.id === this.selectedSet)?.name || 'Set', 
                    image: c.images.small, number: c.number, market: market, rawCost: market, fee: 15, targetGrade: 10,
                    binderId: this.targetBinder === 'master' ? null : this.targetBinder
                };
                if(this.user) db.collection('users').doc(this.user.uid).collection('cards').add(cardData);
                else { cardData.uid = Date.now().toString(); this.localCards.push(cardData); this.saveData(); }
                this.addedIds.push(c.id);
                setTimeout(() => { this.addedIds = this.addedIds.filter(id => id !== c.id); }, 1500);
            },
            deleteCard(uid) {
                if(!confirm("Remove card?")) return;
                if(this.user) db.collection('users').doc(this.user.uid).collection('cards').doc(uid).delete();
                else { this.localCards = this.localCards.filter(c => c.uid !== uid); this.saveData(); }
                this.detailCard = null; 
            },
            updateCardBinder(card) {
                const binderUpdate = { binderId: card.binderId === undefined ? null : card.binderId };
                if(this.user) db.collection('users').doc(this.user.uid).collection('cards').doc(card.uid).update(binderUpdate);
                else this.saveData();
            },
            getEstValue(c) {
                const raw = c.market || 0;
                if(c.targetGrade == 10) return raw * 3.2;
                if(c.targetGrade == 9) return raw * 1.1;
                return raw * 0.85;
            },
            getProfit(c) { return this.getEstValue(c) - ((c.rawCost || 0) + (c.fee || 0)); },
            selectBinder(b) { this.currentBinder = b; this.currentPage = 1; }, 
            getBinderCount(id) { return this.cards.filter(c => c.binderId === id).length; },
            openSearch() { 
                this.showSearch = true; this.searchResults = []; this.searchPage = 1; this.query = '';
                this.targetBinder = this.currentView === 'calculator' && this.currentBinder ? this.currentBinder.id : 'master';
            },
            openCardDetail(c) { this.detailCard = c; },
            formatNumber(n) { return (n||0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}); },
            getCardPrice(c) { 
                const prices = c.tcgplayer?.prices;
                if (!prices) return 0;
                const marketPrices = Object.values(prices).map(p => p?.market).filter(p => p > 0); 
                if (c.tcgplayer?.market && c.tcgplayer.market > 0) marketPrices.push(c.tcgplayer.market);
                return marketPrices.length > 0 ? Math.max(...marketPrices) : 0;
            },
            debouncedSearch() {
                if(this.searchTimeout) clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => { this.fetchCards(1); }, 600); 
            },
            async loadSetsAPI(force=false) {
                this.setsLoading = true;
                const cacheKey = 'cactus_sets_v2';
                const apiKey = '6aa37587-f78b-4bc9-a3ce-3b9eeb6bf149'; 
                if (!force) {
                    const c = localStorage.getItem(cacheKey);
                    if(c) { try { const d = JSON.parse(c); if(d.sets.length>0) { this.allSets=d.sets; this.eras=d.eras; this.totalSetData=d.totalSetData; this.setsLoading=false; return; } } catch(e){} }
                }
                try {
                    const res = await fetch('https://api.pokemontcg.io/v2/sets?select=id,name,series,releaseDate,printedTotal,total&orderBy=-releaseDate', { headers: { 'X-Api-Key': apiKey } });
                    if (!res.ok) throw new Error(`API Error`);
                    const data = await res.json();
                    const setSizeMap = {};
                    data.data.forEach(s => { setSizeMap[s.name] = { total: s.total, printedTotal: s.printedTotal }; });
                    this.allSets = data.data; 
                    this.eras = [...new Set(data.data.map(s => s.series))];
                    this.totalSetData = setSizeMap; 
                    localStorage.setItem(cacheKey, JSON.stringify({ sets: this.allSets, eras: this.eras, totalSetData: this.totalSetData }));
                } catch(e) { console.error("Sync Failed"); } finally { this.setsLoading = false; }
            },
            async fetchCards(page=1) {
                if(!this.selectedSet) return;
                let qName = this.query ? this.query.trim().toLowerCase() : '';
                const cacheKey = `search_${this.selectedSet}_${qName}_${page}`;
                if (this.searchCache[cacheKey]) { this.searchResults=this.searchCache[cacheKey].data; this.totalSearchPagesCount=this.searchCache[cacheKey].total; this.searchPage=page; this.isSearching=false; return; }
                if (searchController) searchController.abort();
                searchController = new AbortController();
                this.isSearching = true; this.searchPage = page; 
                const apiKey = '6aa37587-f78b-4bc9-a3ce-3b9eeb6bf149'; 
                let q = `set.id:${this.selectedSet}`; if(qName) q += ` name:"${qName}*"`; 
                try {
                    const res = await fetch(`https://api.pokemontcg.io/v2/cards?q=${q}&page=${page}&pageSize=18&select=id,name,number,images,tcgplayer&orderBy=number`, { headers: { 'X-Api-Key': apiKey }, signal: searchController.signal });
                    if (!res.ok) throw new Error(`Err`);
                    const data = await res.json();
                    this.searchCache[cacheKey] = { data: data.data || [], total: Math.ceil((data.totalCount || 0) / 18) };
                    this.searchResults = this.searchCache[cacheKey].data;
                    this.totalSearchPagesCount = this.searchCache[cacheKey].total;
                } catch(e) { if (e.name !== 'AbortError') this.searchResults=[]; } finally { if (!searchController.signal.aborted) this.isSearching = false; }
            }
        }
    }).mount('#app');
</script>

</body>
</html>
