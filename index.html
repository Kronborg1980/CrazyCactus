
<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <title>Crazy Cactus ‚Äî Binder Love</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;       /* slate-900 */
      --panel: #111827;    /* gray-900 */
      --muted: #1f2937;    /* gray-800 */
      --accent: #22c55e;   /* green-500 */
      --accent-2: #06b6d4; /* cyan-500 */
      --text: #e5e7eb;     /* gray-200 */
      --sub: #9ca3af;      /* gray-400 */
      --danger: #ef4444;   /* red-500 */
      --warn: #f59e0b;     /* amber-500 */
      --ok: #10b981;       /* emerald-500 */
      --border: #374151;   /* gray-700 */
    }
    * { box-sizing: border-box; }
    html,body { height:100%; }
    body {
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    }
    a { color: var(--accent-2); text-decoration: none; }
    header {
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 18px; background: linear-gradient(90deg, #0b1220, #0b1a26 40%, #0b1220);
      border-bottom:1px solid var(--border);
      position: sticky; top:0; z-index: 10;
    }
    header h1 { font-size: 18px; margin:0; letter-spacing:.5px; }
    header .metrics { display:flex; gap:16px; flex-wrap: wrap; }
    .pill {
      background:var(--muted); padding:8px 10px; border-radius:10px; border:1px solid var(--border);
      display:flex; gap:8px; align-items:center; font-size:13px;
    }
    .pill b { color:#fff; }
    .wrap { display:flex; min-height: calc(100vh - 58px); }
    aside {
      width: 280px; border-right:1px solid var(--border);
      background: #0c1422; padding: 16px; position: sticky; top:58px; height: calc(100vh - 58px); overflow:auto;
    }
    main { flex:1; padding: 16px; display:flex; gap:16px; flex-direction: column; }
    h2,h3,h4 { margin:10px 0; }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding: 14px; }
    .grid { display:grid; gap:16px; }
    .grid.cols-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .grid.cols-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid.cols-4 { grid-template-columns: repeat(4, minmax(0,1fr)); }
    @media (max-width: 1100px) { .grid.cols-3,.grid.cols-4 { grid-template-columns: repeat(2, minmax(0,1fr)); } aside{width: 240px;} }
    @media (max-width: 800px) { .grid.cols-2,.grid.cols-3,.grid.cols-4 { grid-template-columns: 1fr; } aside{display:none;} }
    .muted { color: var(--sub); }
    .btn {
      cursor:pointer; border:1px solid var(--border); background: var(--muted);
      color:#fff; padding:8px 12px; border-radius:8px; font-weight:600;
    }
    .btn:hover { filter: brightness(1.05); }
    .btn.primary { background: linear-gradient(180deg,#1f7a50,#11633f); border-color:#145c3d; }
    .btn.warn { background: linear-gradient(180deg,#7a5a1f,#6a4b10); border-color:#5a3e0c; }
    .btn.danger { background: linear-gradient(180deg,#933131,#7a2222); border-color:#6b1c1c; }
    .btn.ghost { background: transparent; }
    .row { display:flex; gap:12px; flex-wrap: wrap; align-items:center; }
    .row.stretch > * { flex:1; }
    input,select {
      width:100%; padding:8px 10px; border-radius:8px; border:1px solid var(--border);
      background:#0b1220; color:#fff; outline:none;
    }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid var(--border); padding:10px; vertical-align: middle; font-size: 14px; }
    th { text-align:left; color:#cbd5e1; }
    tr:hover td { background:#0c1524; }
    .right { text-align:right; }
    .center { text-align:center; }
    .tag { background:#0b1b2b; border:1px solid #0f2b44; color:#bfe7ff; padding:2px 6px; border-radius:6px; font-size:12px; }
    .small { font-size:12px; }
    .spacer { flex:1; }
    .hr { height:1px; background:var(--border); margin: 10px 0; }
    .hint { color:#a7f3d0; }
    .empty {
      border:1px dashed var(--border); border-radius:10px; padding:16px; text-align:center; color:var(--sub);
      background: #0a1220;
    }
  </style>
</head>
<body>
  <header>
    <h1>üåµ Crazy Cactus ‚Äî <span class="muted">Binder Love</span></h1>
    <div class="metrics">
      <div class="pill">üí∞ Portfolio Value: <b id="m-totalValue">0,00 kr.</b></div>
      <div class="pill">üÉè Total Cards: <b id="m-totalCards">0</b></div>
      <div class="pill">üìö Binders: <b id="m-binders">1</b></div>
    </div>
  </header>

  <div class="wrap">
    <!-- SIDEBAR: Binders -->
    <aside>
      <h3>üìö CARD VAULTS</h3>
      <div class="row">
        <input id="newBinderName" placeholder="+ Ny binder navn‚Ä¶" />
        <button class="btn" id="btnAddBinder">+ NY BINDER</button>
      </div>
      <div class="hr"></div>
      <div id="binderList"></div>
      <div class="hr"></div>
      <div class="small muted">Tip: Klik p√• en binder for at filtrere tabellen. ‚ÄúMaster Archive‚Äù viser alt.</div>
    </aside>

    <!-- MAIN -->
    <main>
      <!-- Dashboard quicks -->
      <div class="grid cols-3">
        <div class="card">
          <h3>üìà Dashboard</h3>
          <div class="row">
            <div class="pill">Net Profit (alle): <b id="m-netAll">0,00 kr.</b></div>
            <div class="pill">Gns. Market/Kort: <b id="m-avgMarket">0,00 kr.</b></div>
          </div>
          <div class="small muted" style="margin-top:8px">Alt er beregnet i realtid og gemmes i din browser (localStorage).</div>
        </div>
        <div class="card">
          <h3>üîé Find My Card</h3>
          <div class="row stretch">
            <div>
              <label class="small muted">1. Era</label>
              <select id="selEra"></select>
            </div>
            <div>
              <label class="small muted">2. Set</label>
              <select id="selSet"></select>
            </div>
          </div>
          <div class="row stretch" style="margin-top:8px">
            <div>
              <label class="small muted">3. Card</label>
              <select id="selCard"></select>
            </div>
            <div>
              <label class="small muted">Market Price</label>
              <div id="marketBox" class="pill">CHECKING‚Ä¶</div>
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="btnAddToBinder">ADD TO BINDER</button>
            <span class="tag" id="addedToast" style="display:none">ADDED TO COLLECTION!</span>
            <span class="spacer"></span>
            <span class="small muted">Aktiv binder: <b id="activeBinderName">Master Archive</b></span>
          </div>
        </div>
        <div class="card">
          <h3>‚öôÔ∏è Indstillinger</h3>
          <div class="row">
            <label class="small muted">Side-st√∏rrelse</label>
            <select id="selPageSize" style="max-width:140px">
              <option>10</option><option selected>20</option><option>50</option><option>100</option>
            </select>
            <span class="spacer"></span>
            <button class="btn ghost small" id="btnReset">Nulstil alt</button>
          </div>
          <div class="small muted" style="margin-top:8px">Nulstil sletter bindere og samling (kun lokalt).</div>
        </div>
      </div>

      <!-- Collection Table -->
      <div class="card">
        <div class="row" style="margin-bottom:8px">
          <h3 style="margin:0">üóÉÔ∏è <span id="tableTitle">Master List</span> ‚Äî Profitability Analysis</h3>
          <span class="spacer"></span>
          <button id="btnDelete" class="btn danger" disabled>DELETE 0 ITEMS</button>
        </div>

        <div id="tableWrap"></div>

        <div class="row" style="margin-top:10px">
          <div class="small muted" id="visibleCount">0 items visible</div>
          <span class="spacer"></span>
          <button class="btn" id="btnPrev">PREV</button>
          <button class="btn" id="btnNext">NEXT</button>
        </div>
      </div>

      <!-- Helpful info -->
      <div class="empty">
        <h4>üåµ This Desert is Empty</h4>
        <div>Plant your first seed og se den gro ‚Äî brug ‚ÄúFind My Card‚Äù ovenfor og klik <b>ADD TO BINDER</b>.</div>
      </div>
    </main>
  </div>

  <script>
  // ==========
  // UTILITIES
  // ==========
  const DKK = new Intl.NumberFormat('da-DK', { style: 'currency', currency: 'DKK', minimumFractionDigits: 2 });
  const NUM = new Intl.NumberFormat('da-DK', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const uid = () => Math.random().toString(36).slice(2,10);
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

  // ======================
  // MOCK DATA (offline)
  // ======================
  const MOCK = (() => {
    const eras = ['Vintage', 'Modern'];
    const sets = [
      { id: 'base-1999', era: 'Vintage', name: 'Base Set (1999)', total: 102 },
      { id: 'jungle-1999', era: 'Vintage', name: 'Jungle (1999)', total: 64 },
      { id: 'sv-2023', era: 'Modern', name: 'Scarlet & Violet (2023)', total: 198 },
      { id: 'pa-2024', era: 'Modern', name: 'Paradox Rift (2024)', total: 182 },
    ];
    // Gener√©r et lille kortkatalog pr. set
    const cardsBySet = {};
    for (const s of sets) {
      const list = [];
      const baseNames = ['Bulbasaur','Charmander','Squirtle','Pikachu','Eevee','Mew','Mewtwo','Charizard','Blastoise','Venusaur'];
      for (let i=1;i<=20;i++){
        const name = baseNames[i % baseNames.length] + (i>10? ' ‚ñ≤':'');
        // Market svinger pr. set, lidt h√∏jere i Vintage
        const base = s.era === 'Vintage' ? 50 : 10;
        const market = +(base + Math.random()* (s.era==='Vintage'? 200:60)).toFixed(2);
        list.push({
          id: `${s.id}-${i}`,
          setId: s.id,
          number: i,
          name,
          market,
        });
      }
      cardsBySet[s.id] = list;
    }
    return { eras, sets, cardsBySet };
  })();

  // ======================
  // STATE + STORAGE
  // ======================
  const STORAGE_KEY = 'cactus_state_v1';
  const defaultState = () => ({
    binders: [ { id: 'master', name: 'Master Archive' } ],
    currentBinder: 'master',
    collection: [], // items: { rowId, cardId, setId, name, number, market, binderId, rawCost, fees, grade }
    ui: {
      page: 1,
      pageSize: 20,
      filterBinder: 'master', // 'master' viser alt
      selEra: '',
      selSet: '',
      selCard: '',
    }
  });

  let state = loadState();

  function loadState(){
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return defaultState();
      const obj = JSON.parse(raw);
      // defensiv migration
      obj.ui ||= defaultState().ui;
      obj.binders ||= defaultState().binders;
      obj.currentBinder ||= 'master';
      return obj;
    } catch {
      return defaultState();
    }
  }
  const saveState = throttle(() => localStorage.setItem(STORAGE_KEY, JSON.stringify(state)), 150);

  function throttle(fn, wait=150){
    let t=0, lastArgs=null, queued=false;
    return (...args) => {
      const now = Date.now();
      lastArgs = args;
      if (!queued && now - t > wait){
        queued = true;
        requestAnimationFrame(() => {
          queued=false; t=Date.now(); fn(...lastArgs);
        });
      }
    };
  }

  // ======================
  // BUSINESS LOGIC
  // ======================
  const gradeMultipliers = { 'PSA 8': 0.85, 'PSA 9': 0.95, 'PSA 10': 1.15 };
  const defaultGrade = 'PSA 9';

  function getSetsByEra(era){
    return MOCK.sets.filter(s => s.era === era);
  }
  function getCardsInSet(setId){
    return MOCK.cardsBySet[setId] || [];
  }
  function getCardPrice(card){
    return card?.market ?? 0;
  }
  function estValue(item){
    const mult = gradeMultipliers[item.grade] ?? 1;
    return +(item.market * mult).toFixed(2);
  }
  function profit(item){
    return +(estValue(item) - (toNum(item.rawCost)+toNum(item.fees))).toFixed(2);
  }
  function toNum(v){ const n = parseFloat(v); return isNaN(n) ? 0 : n; }

  // ======================
  // RENDERING
  // ======================
  const el = {
    mTotalValue: $('#m-totalValue'),
    mTotalCards:  $('#m-totalCards'),
    mBinders:     $('#m-binders'),
    mNetAll:      $('#m-netAll'),
    mAvgMarket:   $('#m-avgMarket'),
    binderList:   $('#binderList'),
    activeBinderName: $('#activeBinderName'),
    selEra:       $('#selEra'),
    selSet:       $('#selSet'),
    selCard:      $('#selCard'),
    marketBox:    $('#marketBox'),
    btnAddToBinder: $('#btnAddToBinder'),
    addedToast:   $('#addedToast'),
    tableWrap:    $('#tableWrap'),
    tableTitle:   $('#tableTitle'),
    visibleCount: $('#visibleCount'),
    btnPrev:      $('#btnPrev'),
    btnNext:      $('#btnNext'),
    btnDelete:    $('#btnDelete'),
    selPageSize:  $('#selPageSize'),
    emptyBlock:   $('.empty'),
    btnAddBinder: $('#btnAddBinder'),
    newBinderName: $('#newBinderName'),
    btnReset:     $('#btnReset'),
  };

  function renderAll(){
    renderMetrics();
    renderBinders();
    renderFindSelectors();
    renderMarketBox();
    renderTable();
    saveState();
  }

  function renderMetrics(){
    const items = filteredCollection();
    const tv = items.reduce((s,i)=> s + estValue(i), 0);
    const net = items.reduce((s,i)=> s + profit(i), 0);
    const avgM = items.length ? items.reduce((s,i)=> s + i.market,0) / items.length : 0;

    el.mTotalValue.textContent = DKK.format(tv);
    el.mNetAll.textContent = DKK.format(net);
    el.mAvgMarket.textContent = DKK.format(avgM);
    el.mTotalCards.textContent = String(items.length);
    el.mBinders.textContent = String(state.binders.length);
  }

  function renderBinders(){
    const list = document.createElement('div');
    for (const b of state.binders){
      const count = state.collection.filter(it => it.binderId === b.id || state.ui.filterBinder === 'master').length;
      const btn = document.createElement('button');
      btn.className = 'btn' + (state.ui.filterBinder === b.id ? ' primary' : '');
      btn.style.width='100%'; btn.style.marginBottom='8px';
      btn.textContent = b.name + (b.id==='master' ? ` ‚Äî Total: ${state.collection.length}` : ` ‚Äî ${binderCount(b.id)} Cards`);
      btn.onclick = () => { state.ui.filterBinder = b.id; state.ui.page=1; el.activeBinderName.textContent=b.name; renderAll(); };
      list.appendChild(btn);
    }
    el.binderList.innerHTML='';
    el.binderList.appendChild(list);
    el.tableTitle.textContent = (state.ui.filterBinder==='master' ? 'Master List' : (state.binders.find(b=>b.id===state.ui.filterBinder)?.name || 'Binder'));
  }

  function binderCount(id){
    return state.collection.filter(i => i.binderId === id).length;
  }

  function renderFindSelectors(){
    // Era
    const eras = ['', ...MOCK.eras];
    el.selEra.innerHTML = eras.map(e => `<option value="${e}">${e?e:'SELECT ERA'}</option>`).join('');
    el.selEra.value = state.ui.selEra;

    // Set afh√¶nger af era
    const sets = state.ui.selEra ? getSetsByEra(state.ui.selEra) : [];
    el.selSet.innerHTML = [''].concat(sets).map(s => {
      if (!s) return `<option value="">SELECT SET</option>`;
      return `<option value="${s.id}">${s.name}</option>`;
    }).join('');
    if (!sets.find(s => s?.id === state.ui.selSet)) state.ui.selSet = '';
    el.selSet.value = state.ui.selSet;

    // Cards afh√¶nger af set
    const cards = state.ui.selSet ? getCardsInSet(state.ui.selSet) : [];
    el.selCard.innerHTML = [''].concat(cards).map(c => {
      if (!c) return `<option value="">${cards.length? 'SELECT CARD':'EMPTY SET'}</option>`;
      return `<option value="${c.id}">#${c.number} ‚Äî ${c.name}</option>`;
    }).join('');
    if (!cards.find(c => c?.id === state.ui.selCard)) state.ui.selCard = '';
    el.selCard.value = state.ui.selCard;
  }

  function renderMarketBox(){
    const card = currentSelectedCard();
    if (!card) { el.marketBox.textContent = 'CHECKING‚Ä¶'; return; }
    el.marketBox.textContent = DKK.format(getCardPrice(card));
  }

  function currentSelectedCard(){
    const setId = state.ui.selSet;
    const cId = state.ui.selCard;
    if (!setId || !cId) return null;
    return getCardsInSet(setId).find(c => c.id === cId) || null;
  }

  function filteredCollection(){
    if (state.ui.filterBinder === 'master') return state.collection;
    return state.collection.filter(i => i.binderId === state.ui.filterBinder);
  }

  function renderTable(){
    const all = filteredCollection();
    const pageSize = +state.ui.pageSize || 20;
    const maxPage = Math.max(1, Math.ceil(all.length / pageSize));
    state.ui.page = clamp(state.ui.page, 1, maxPage);
    const start = (state.ui.page - 1) * pageSize;
    const pageItems = all.slice(start, start + pageSize);

    // Header + rows
    const table = document.createElement('table');
    table.innerHTML = `
      <thead>
        <tr>
          <th class="center" style="width:34px"><input type="checkbox" id="chkAll"></th>
          <th style="width:60px">Visual</th>
          <th>Card Identity</th>
          <th>Binder Location</th>
          <th class="right">Raw Cost</th>
          <th class="right">Fees</th>
          <th style="width:120px">Target Grade</th>
          <th class="right">Est. Value</th>
          <th class="right">Net Profit</th>
          <th>Ops</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    `;
    const tbody = $('tbody', table);

    if (pageItems.length === 0){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 10;
      td.innerHTML = `<div class="empty">No cards buried here‚Ä¶</div>`;
      tr.appendChild(td);
      tbody.appendChild(tr);
    } else {
      for (const it of pageItems){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="center"><input type="checkbox" class="rowChk" data-row="${it.rowId}"></td>
          <td class="center"><div class="tag">#${it.number}</div></td>
          <td>
            <div><b>${it.name}</b></div>
            <div class="small muted">${it.setId} ¬∑ #${it.number}</div>
          </td>
          <td>${state.binders.find(b => b.id === it.binderId)?.name || 'Master Archive'}</td>
          <td class="right"><input type="number" step="0.01" value="${toNum(it.rawCost)}" data-row="${it.rowId}" data-k="rawCost"></td>
          <td class="right"><input type="number" step="0.01" value="${toNum(it.fees)}" data-row="${it.rowId}" data-k="fees"></td>
          <td>
            <select data-row="${it.rowId}" data-k="grade">
              ${Object.keys(gradeMultipliers).map(g => `<option ${it.grade===g?'selected':''}>${g}</option>`).join('')}
            </select>
          </td>
          <td class="right">${DKK.format(estValue(it))}</td>
          <td class="right ${profit(it)>=0?'hint':''}">${DKK.format(profit(it))}</td>
          <td><button class="btn warn small" data-del="${it.rowId}">Remove</button></td>
        `;
        tbody.appendChild(tr);
      }
    }

    // Mount and bind events
    el.tableWrap.innerHTML = '';
    el.tableWrap.appendChild(table);

    // Events for inputs
    $$('input[type="number"]', table).forEach(inp => {
      inp.addEventListener('change', e => {
        const rowId = e.target.dataset.row;
        const key = e.target.dataset.k;
        const it = state.collection.find(x => x.rowId === rowId);
        if (it){ it[key] = toNum(e.target.value); renderAll(); }
      });
    });
    $$('select[data-k="grade"]', table).forEach(sel => {
      sel.addEventListener('change', e => {
        const rowId = e.target.dataset.row;
        const it = state.collection.find(x => x.rowId === rowId);
        if (it){ it.grade = e.target.value; renderAll(); }
      });
    });
    $$('button[data-del]', table).forEach(btn => {
      btn.addEventListener('click', e => {
        const rowId = e.target.dataset.del;
        state.collection = state.collection.filter(x => x.rowId !== rowId);
        renderAll();
      });
    });

    // Select-all + row selection
    const allChks = $$('.rowChk', table);
    const chkAll = $('#chkAll', table);
    const updateDeleteState = () => {
      const selected = selectedRows();
      el.btnDelete.disabled = selected.length === 0;
      el.btnDelete.textContent = `DELETE ${selected.length} ITEMS`;
    };
    if (chkAll) {
      chkAll.addEventListener('change', () => {
        allChks.forEach(c => c.checked = chkAll.checked);
        updateDeleteState();
      });
    }
    allChks.forEach(c => c.addEventListener('change', updateDeleteState));
    updateDeleteState();

    // Pagination footer
    el.visibleCount.textContent = `${pageItems.length} items visible`;
    el.btnPrev.onclick = () => { if (state.ui.page>1){ state.ui.page--; renderTable(); } };
    el.btnNext.onclick = () => { if (state.ui.page<maxPage){ state.ui.page++; renderTable(); } };

    // Empty helper visibility
    el.emptyBlock.style.display = state.collection.length ? 'none' : 'block';
  }

  function selectedRows(){
    return $$('.rowChk:checked', el.tableWrap).map(c => c.dataset.row);
  }

  // ======================
  // EVENTS (top-level)
  // ======================
  el.selEra.addEventListener('change', () => {
    state.ui.selEra = el.selEra.value;
    state.ui.selSet = ''; state.ui.selCard = '';
    renderAll();
  });
  el.selSet.addEventListener('change', () => {
    state.ui.selSet = el.selSet.value;
    state.ui.selCard = '';
    renderAll();
  });
  el.selCard.addEventListener('change', () => {
    state.ui.selCard = el.selCard.value;
    renderMarketBox();
  });

  el.btnAddToBinder.addEventListener('click', () => {
    const c = currentSelectedCard();
    if (!c) return;
    const row = {
      rowId: uid(),
      cardId: c.id,
      setId: c.setId,
      name: c.name,
      number: c.number,
      market: c.market,
      binderId: state.ui.filterBinder || 'master',
      rawCost: 0,
      fees: 0,
      grade: defaultGrade
    };
    state.collection.unshift(row);
    toastAdded();
    renderAll();
  });

  el.btnDelete.addEventListener('click', () => {
    const rows = selectedRows();
    if (!rows.length) return;
    state.collection = state.collection.filter(x => !rows.includes(x.rowId));
    renderAll();
  });

  el.selPageSize.addEventListener('change', () => {
    state.ui.pageSize = +el.selPageSize.value;
    state.ui.page = 1;
    renderAll();
  });

  el.btnAddBinder.addEventListener('click', () => {
    const name = (el.newBinderName.value || '').trim();
    if (!name) return;
    const id = uid();
    state.binders.push({ id, name });
    state.ui.filterBinder = id;
    el.newBinderName.value='';
    renderAll();
  });

  el.btnReset.addEventListener('click', () => {
    if (!confirm('Er du sikker? Dette sletter alle lokale data.')) return;
    state = defaultState();
    renderAll();
  });

  function toastAdded(){
    el.addedToast.style.display = 'inline-block';
    setTimeout(()=> el.addedToast.style.display='none', 1500);
  }

  // Init selectors default
  if (!state.ui.selEra) state.ui.selEra = MOCK.eras[0];
  if (!state.ui.selSet) state.ui.selSet = getSetsByEra(state.ui.selEra)[0]?.id || '';
  el.selPageSize.value = state.ui.pageSize;

  // Initial render
  renderAll();
  </script>
</body>
</html>
