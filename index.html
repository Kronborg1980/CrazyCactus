<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crazy Cactus | Binder Love</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Kronborg1980/CrazyCactus/main/channels4_profile.jpg">
   
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
   
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --neon-green: #39ff14; --glass-surface: rgba(15, 12, 41, 0.75); }
        body { font-family: 'Outfit', sans-serif; background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460); background-size: 400% 400%; animation: gradientBG 15s ease infinite; color: #e2e8f0; min-height: 100vh; }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        [v-cloak] { display: none; }
        .glass-panel { background: var(--glass-surface); backdrop-filter: blur(24px); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.6); border-radius: 20px; transition: all 0.3s; }
        .glass-panel:hover { box-shadow: 0 15px 45px 0 rgba(57, 255, 20, 0.2); border-color: rgba(57, 255, 20, 0.4); transform: translateY(-4px); }
        .bg-watermark { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80vw; height: 80vh; opacity: 0.05; pointer-events: none; z-index: -2; background-image: url('https://raw.githubusercontent.com/Kronborg1980/CrazyCactus/main/channels4_profile.jpg'); background-size: contain; background-repeat: no-repeat; background-position: center; filter: grayscale(1) contrast(2); }
        .btn-neon { background: linear-gradient(135deg, var(--neon-green), #2ecc71); color: #000; font-weight: 800; text-transform: uppercase; padding: 12px 24px; border-radius: 12px; box-shadow: 0 0 15px rgba(57, 255, 20, 0.4); transition: all 0.3s; }
        .btn-neon:hover { transform: scale(1.05) translateY(-2px); box-shadow: 0 0 30px var(--neon-green); }
        .btn-neon:disabled { filter: grayscale(1); opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .glass-input { background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.15); color: white; padding: 12px; border-radius: 12px; width: 100%; transition: 0.3s; }
        .glass-input:focus { border-color: var(--neon-green); background: rgba(0,0,0,0.9); box-shadow: 0 0 20px rgba(57, 255, 20, 0.4); outline: none; }
        .nav-item { color: #a0aec0; font-weight: 600; padding: 10px 18px; border-radius: 12px; transition: 0.3s; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.1); transform: scale(1.05); }
        .nav-item.active { background: rgba(57, 255, 20, 0.15); color: var(--neon-green); text-shadow: 0 0 10px rgba(57, 255, 20, 0.8); border: 1px solid rgba(57, 255, 20, 0.4); }
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .data-table th { text-align: left; padding: 16px; font-size: 11px; font-weight: 800; text-transform: uppercase; color: var(--neon-green); letter-spacing: 1px; }
        .data-table td { padding: 12px 16px; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .data-table tr td:first-child { border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
        .data-table tr td:last-child { border-top-right-radius: 12px; border-bottom-right-radius: 12px; }
        .data-table tr:hover td { background: rgba(57, 255, 20, 0.1); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); border-radius: 10px;}
        ::-webkit-scrollbar-thumb { background: rgba(57, 255, 20, 0.3); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-green); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.4s, transform 0.4s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; transform: scale(0.9); }
        .scan-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .scanner-beam { position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: var(--neon-green); box-shadow: 0 0 30px var(--neon-green); animation: scan 1.5s infinite linear; opacity: 0.9; }
        @keyframes scan { 0% { top: 0; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
    </style>
</head>
<body class="bg-fixed">
<div class="bg-watermark"></div>
<div id="app" v-cloak class="min-h-screen flex flex-col relative z-10">
    <!-- ... ALL YOUR HTML (nav, main, modals) is unchanged ... -->
    <!-- (I kept it exactly the same except the script below) -->

<script>
    const WORKER_URL = "https://cactus-proxy.kronborgnielsen.workers.dev";
    const firebaseConfig = {
      apiKey: "AIzaSyAhV2qCJE2tl1SUN4EyY3oKFSB2u-dUChM",
      authDomain: "crazycactus-6cad9.firebaseapp.com",
      projectId: "crazycactus-6cad9",
      storageBucket: "crazycactus-6cad9.firebasestorage.app",
      messagingSenderId: "1075800361912",
      appId: "1:1075800361912:web:e7285e3e74bce49b03dd4d"
    };
    let auth, db, provider;
    try {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        provider = new firebase.auth.GoogleAuthProvider();
    } catch(e) { console.log("Guest Mode Active"); }
    const { createApp } = Vue;
    let searchController = null;
    createApp({
        data() {
            return {
                user: null, currentView: 'collection', currentBinder: null, localBinders: [], localCards: [], cloudBinders: [], cloudCards: [],
                showSearch: false, detailCard: null, setsLoading: false, isSearching: false, searchError: false,
                allSets: [], eras: [], selectedEra: "", selectedSet: "", query: "", targetBinder: 'master', searchResults: [],
                sortBy: 'profit', sortDesc: true, currentPage: 1, itemsPerPage: 60,
                searchPage: 1, addedIds: [], selectedIds: [], searchSort: 'price-desc', totalSearchPagesCount: 1, searchCache: {}, searchTimeout: null,
                currentRequestId: 0, displayList: [],
                globalError: null,
                totalSetData: {}
            }
        },
        // ... all your computed, watch, mounted, methods stay the same EXCEPT fetchCards ...
        methods: {
            // ... (all other methods unchanged) ...

            async loadSetsAPI() {
                this.setsLoading = true;
                this.globalError = null;
                try {
                    const res = await fetch(`${WORKER_URL}/?endpoint=sets&select=id,name,series,releaseDate,printedTotal,total&orderBy=-releaseDate`);
                    if (!res.ok) throw new Error(`Proxy Blocked - Status ${res.status}`);
                    const data = await res.json();
                    if (!data || !data.data) throw new Error("Proxy connected, but returned invalid data.");
                    
                    const setSizeMap = {};
                    data.data.forEach(s => { setSizeMap[s.name] = { total: s.total, printedTotal: s.printedTotal }; });
                   
                    this.allSets = data.data;
                    this.eras = [...new Set(data.data.map(s => s.series))];
                    this.totalSetData = setSizeMap;
                   
                    localStorage.setItem('cactus_sets_v18_proxy', JSON.stringify({ sets: this.allSets, eras: this.eras, totalSetData: this.totalSetData }));
                } catch(e) {
                    console.error("FATAL SETS ERROR:", e);
                    this.globalError = `Could not load sets: ${e.message}`;
                } finally {
                    this.setsLoading = false;
                }
            },

            async fetchCards(page=1, force=false) {
                if(!this.selectedSet && !this.query) return;
                if (searchController) searchController.abort();
                searchController = new AbortController();
               
                this.currentRequestId++;
                const requestId = this.currentRequestId;
                this.isSearching = true;
                this.searchError = false;
                this.searchPage = page;
               
                // FIXED QUERY SYNTAX (this was the main problem)
                let qName = this.query ? this.query.trim() : '';
                let qParts = [];
                if (this.selectedSet) qParts.push(`set.id:${this.selectedSet}`);
                if (qName) qParts.push(`name:*${qName}*`);   // * = wildcard anywhere
                const q = qParts.join(' ');

                const limit = 60;
                let orderBy = 'number';
                if(this.searchSort === 'name') orderBy = 'name';

                try {
                    const url = `${WORKER_URL}/?endpoint=cards&q=${encodeURIComponent(q)}&page=${page}&pageSize=${limit}&select=id,name,number,images,tcgplayer,set&orderBy=${orderBy}`;
                   
                    const res = await fetch(url, { signal: searchController.signal });
                   
                    if (!res.ok) throw new Error(`Proxy Blocked - Status ${res.status}`);
                    let payload = await res.json();
                   
                    if (requestId !== this.currentRequestId) return;
                    let results = payload.data || [];
                    
                    // Client-side price sort (kept from your original)
                    if (this.searchSort === 'price-desc') {
                        results.sort((a, b) => this.getCardPrice(b) - this.getCardPrice(a));
                    } else if (this.searchSort === 'price-asc') {
                        results.sort((a, b) => this.getCardPrice(a) - this.getCardPrice(b));
                    }
                   
                    this.searchResults = results;
                    this.totalSearchPagesCount = Math.ceil((payload.totalCount || 0) / limit) || 1;
                } catch(e) {
                    if (e.name !== 'AbortError') {
                        console.error("SEARCH ERROR:", e);
                        this.searchResults = [];
                        this.searchError = true;
                        this.globalError = `Card Search Failed: ${e.message}`;
                    }
                } finally {
                    if (requestId === this.currentRequestId) {
                         this.isSearching = false;
                    }
                }
            }
            // ... rest of your methods (addCard, deleteCard, etc.) remain exactly the same ...
        }
    }).mount('#app');
</script>
</body>
</html>
